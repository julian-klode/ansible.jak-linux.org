---

- name: install postfix
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - postfix
    state: present

- name: esure postfix is running
  service:
    name: postfix
    state: started
    enabled: yes

- name: install postfix master.cf
  copy: src=etc/postfix/master.cf dest=/etc/postfix/master.cf
  register: postfix_master_cf

- name: install postfix main.cf
  template: src=main.cf.j2 dest=/etc/postfix/main.cf
  register: postfix_main_cf

- name: reload postfix on config change
  service:
    name: postfix
    state: reloaded
  when: postfix_master_cf.changed or postfix_main_cf.changed

# Open ports
- name: ufw allow Postfix
  ufw: rule=allow name=Postfix

- name: ufw allow Postfix Submission
  ufw: rule=limit name="Postfix Submission"

# Check availability
- name: ensure smtp port is open
  wait_for:
    host: "{{ inventory_hostname }}"
    port: 25
    timeout: 1
  delegate_to: localhost
  tags: assert

- name: ensure submit port is open
  wait_for:
    host: "{{ inventory_hostname }}"
    port: 587
    timeout: 1
  delegate_to: localhost
  tags: assert

- name: install haveged
  apt: name=haveged state=present
  become: true
- name: install apparmor
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - apparmor-utils
    - apparmor-profiles
- name: install ufw
  apt: name=ufw
  become: true
- ufw: state=enabled
  become: true
- name: install openssh-server
  apt: name=openssh-server state=present
  become: true
- service:
    name: ssh
    state: started
    enabled: yes
  become: true
  name: ensure openssh-server is running
- ufw: rule=allow name=OpenSSH
  become: true
- name: check for ssh
  wait_for:
    host: "{{ inventory_hostname }}"
    port: 22
    timeout: 1
  delegate_to: localhost
- name: make sure apt pipelining is enabled
  file: name=/etc/apt/apt.conf.d/90cloud-init-pipelining state=absent
  become: true
